<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>NICE Trajectory Editor</title>
  <link rel="icon" type="image/png" href="css/appicon.png" />
    <link rel="stylesheet" type="text/css" href="../../niceclient/static/css/layout-default-latest.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Special+Elite" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Love+Ya+Like+A+Sister" />
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/redmond/jquery-ui.css" />
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../niceclient/static/jquery.layout-latest.js"></script>
  <!--<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />-->
  <!--<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" />-->
  <!--<link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/redmond/jquery-ui.css" />-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
  <!--<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>-->
  <!-- dialog support -->
    <link rel="stylesheet" href="../static/dialog-polyfill.css" />
    <script type="text/javascript" src="../static/dialog-polyfill.js"></script>
  
  <script type="text/javascript">
    if (typeof jQuery == 'undefined')
        {
            document.write(unescape("%3Cscript src='jquery-1.11.1.min.js' type='text/javascript'%3E%3C/script%3E"));
        }
        
    if (typeof jQuery.ui == 'undefined')
        {
            document.write(unescape("%3Cscript src='jquery-ui.min.js' type='text/javascript'%3E%3C/script%3E"));
        }
  </script>
<!--  <script src="http://code.jquery.com/jquery-1.9.1.js"></script>-->
<!-- <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>-->
  <script src="sprintf.js"></script>
  <script src="webtraj_base_prototype.js"></script>
  <script src="webtraj_interactive.js"></script>
  <script src="dryrun_client.js"></script>
<!--  <script src="jsonpatch.js"></script> -->
<!--  <script src="jsondiff.js"></script> -->
  
  <script src="icejs/Ice.js"></script>
  <script src="icejs/Glacier2.js"></script>
  <script src="icejs/IceStorm.js"></script>
  <script src="icejs/IceGrid.js"></script>

    <script src="generated/data.js"></script>
    <script src="generated/devices.js"></script>
    <script src="generated/file.js"></script>
    <script src="generated/console.js"></script>
    <script src="generated/system.js"></script>
    <script src="generated/dryrun.js"></script>
    <script src="generated/exceptions.js"></script>
    <script src="generated/nice.js"></script>
    <script src="generated/events.js"></script>
    <script src="generated/experiment.js"></script>
    <script src="generated/queue.js"></script>
    <script src="generated/sampleAlignment.js"></script>
    <script src="generated/clientapi.js"></script>
    
    <script src="DevicesMonitorI.js"></script>
    <script src="connect_zeroc.js"></script>
  <link rel="stylesheet" href="css/webtraj.css" />
  <script type="text/javascript">
    var Promise = Ice.Promise;
    var RouterPrx = Glacier2.RouterPrx;
    var router_spec = "NiceGlacier2/router:ws -p <port> -h <host>";
    var ice_protocol_version = "1.0";
            
    var logging_in = false;

    var nice_hostname = "h123062.ncnr.nist.gov"; // default NICE host
    var port = '9999';
    if (localStorage && localStorage.nice_hostname) {
        nice_hostname = localStorage.nice_hostname
    }
    console.log(nice_hostname);
    var api;
    var instrument_canonical_ip = {
        '129.6.120.90': 'magik.ncnr.nist.gov',
        '129.6.120.84': 'pbr.ncnr.nist.gov',
        '129.6.120.121': 'ngbsans.ncnr.nist.gov',
        '129.6.120.247': 'echo.ncnr.nist.gov',
        '129.6.120.94': 'bt4.ncnr.nist.gov',
        '129.6.123.130': 'h123130.ncnr.nist.gov',
        '129.6.120.111': 'ng7refl.ncnr.nist.gov',
        '129.6.123.10': 'h123010.ncnr.nist.gov'
    }
    var experimentMonitor, fileMonitor, devicesMonitor;
    
  </script>
  <script type="text/javascript" src="webtraj_page_websocket.js"></script>
  <style type="text/css">
    #files {
        overflow: hidden;
    }
  </style>
  <script type="text/javascript">
    
    var FileMonitorI = Ice.Class(nice.api.file.FileMonitor, {
        __init__: function() {
            this.pathseparator = '/';
        },
        onSubscribe: function(root, __current) {
            this._root = root;
            this.added = [];
            this.removed = [];
            this.updated = [];
            this.contents = [];
        },
        filesAdded: function(nodes, contents, __current) {
            if (nodes.length != contents.length) {
                console.log('error! lengths of added nodes doesn\'t match contents');
                return
            }
            var n, c, ip;
            for (var i=0; i<nodes.length; i++) {
                n = nodes[i];
                c = contents[i];
                ip = this._findInsertionPoint(n.name, this._root, 2);
                ip.children.push(n)               
            };
            refreshBoth();
            this.added.push([nodes, contents]);
        },
        filesRemoved: function(nodes, contents, __current) {
            this.removed.push([nodes, contents]);
        },
        filesUpdated: function(nodes, contents, __current) {
            this.updated.push([nodes, contents]);
        },
        filesContents: function(nodes, contents, __current) {
            this.contents.push([nodes, contents]);
        },
        // end overrides
        _findInsertionPoint: function(nodename, target, level) {
            //console.log(nodename, target, level);
            var pathtokens = nodename.split(this.pathseparator);
            var nextpath = pathtokens.slice(0, level).join(this.pathseparator) + this.pathseparator;
            //console.log(nextpath);
            var nexttarget = target.children.filter(function(c) { return new RegExp('\^' + nextpath).test( c.name ) })[0];
            if (level < (pathtokens.length - 1)) {
                return this._findInsertionPoint(nodename, nexttarget, (level+1))
            } else {
                return nexttarget
            }
        }
    });
    var ExperimentMonitorI = Ice.Class(nice.api.experiment.ExperimentMonitor, {
        onSubscribe: function(all_experiments, current_experiment, __current) {
            this.all_experiments = all_experiments;
            this.current_experiment = current_experiment;
            this.postChangedHooks = (this.postChangedHooks == null) ? [] : this.postChangedHooks;
            this.postChangedHooks.forEach( function(callback) { callback(current_experiment); });
        },
        switchedCurrentExperiment: function(current_experiment, __current) {
            this.current_experiment = current_experiment;
        },
        modifiedCurrentExperiment: function(data,  __current) {
            this._last_modified = data;
        },
        createdExperiment: function(data,  __current) {
            this._last_created = data;
        },
        HashMapToObject: function(m) {
            var obj={}; 
            m.forEach( function(dn) { 
                obj[dn]=m.get(dn);
            }); 
            return obj
        } 
    });
    dialog_login = function() {
        
        // set the global hostname
        var nice_hostname = document.getElementById("instrument_ip").value;
        var username = document.getElementById("username").value;
        var password = document.getElementById("password").value;
        
        signin(router_spec.replace(/<host>/, nice_hostname).replace(/<port>/, port), ice_protocol_version, true, username, password).then(
            function(api_object) {
                // globals:
                logging_in = false;
                api = api_object;
                devicesMonitor = new DevicesMonitorI();
                fileMonitor = new FileMonitorI();
                experimentMonitor = new ExperimentMonitorI();
                //devicesMonitor.postChangedHooks = [handleNodesChanged];
                experimentMonitor.postChangedHooks = [refreshBoth];
                return Promise.all(
                    subscribe(devicesMonitor, 'devices'),
                    subscribe(fileMonitor, 'file'),
                    subscribe(experimentMonitor, 'experiment')
                )//.then(function() { refreshBoth(); })
        }).exception(
            function(ex) {console.log(ex)}
        );
        
        if (localStorage) {
            localStorage.nice_hostname = nice_hostname;
        }
        document.getElementById("login").close();
    }
    window.onload = function () { 
	    //$('body').layout({ applyDemoStyles: true });
	    var dialog = document.getElementById("login");
        if (!dialog.show) {
            dialogPolyfill.registerDialog(dialog);
        }
        document.getElementById("instrument_ip").value = nice_hostname;
	    //hostname = document.getElementById("instrument_ip").value;
	    dialog.show();
        logging_in = true;
        
	    var layout = $('body').layout({
			west__size:			300
		,	east__size:			0
		,   south__size:        "auto"
			// RESIZE Accordion widget when panes resize
		,	west__onresize:		$.layout.callbacks.resizePaneAccordions
		,	east__onresize:		$.layout.callbacks.resizePaneAccordions
		,	south__onresize:		$.layout.callbacks.resizePaneAccordions
		});
		
		var eb = $('#catalog');
    
        update_interactiveness = function() {
            var interactive = document.getElementById('interactive').checked;
            if (!(interactive)) { 
                eb.hide(); 
            } else {
                eb.show();
            }
            if (wt.raw) { // && wt.filename) {
                var filename = wt.filename;
                var new_editor = set_data(wt.raw);
                new_editor.filename = filename;
            }
            layout.resizeAll();
        }
       
        //getDevices().then(refreshBoth);
        //refreshBoth();
    
    };
  </script>
  <style type="text/css">
    #login {
        top: 28%;
        position: absolute;
        z-index: 10;
    }
  </style>
</head>
<body>
<dialog id="login">
  <h2>Login</h2>
  <label for="instrument_ip">Instrument address</label>
  <input type="text" id="instrument_ip" value="happy.home">
  <br>
  <label for="username">Username:</label>
  <input type="text" id="username" value="" placeholder="username">
  <br>
  <label for="password">Password:</label>
  <input type="password" id="password" placeholder="password">
  <br>
  <input type="button" onclick="dialog_login()" value="Go">
</dialog>
<div id="files" class="ui-layout-wrapper ui-layout-west">
     <h3 class="ui-widget-header" style="display:block;">Trajectories</h3>
     <div id="filelist" tabindex=1> 
     <ol id="filelist_ol" tabindex=2></ol>
     </div>
</div>
<div id="bottom_panel" class="ui-layout-south">
    <div id="buttons" style="display:inline-block;"></div>
    <div id="bulk_edit_buttons" style="display: inline-block;"></div>
</div>
<div id="top_panel" class="ui-layout-north">
    <div id="statusline">Trajectory Editor</div>
    <div id="catalog">
        Drag onto editor below: 
        <span class="catalog-item vary-catalog-item ui-state-default" name="range" title="drag onto a loop below">+ range</span>
        <span class="catalog-item init-catalog-item vary-catalog-item ui-state-default" name="expression" title="drag onto a loop below">+ expression</span>
        <span class="catalog-item init-catalog-item ui-state-default" name="obj" title="drag onto a loop below">+ object</span>
        <span class="catalog-item init-catalog-item vary-catalog-item ui-state-default" name="list" title="drag onto a loop below">+ list</span>
        <span class="catalog-item init-catalog-item vary-catalog-item ui-state-default" name="counter" title="drag onto a loop below">+ counter</span>
        <span class="catalog-item vary-catalog-item ui-state-default" name="cycliclist" title="drag onto a loop below">+ cyclic list</span>
        <span class="catalog-item loops-catalog-item ui-state-default" name="loop" title="drag onto a loop below">+ vary</span>
        <span class="catalog-item loop-catalog-item main-catalog-item ui-state-default" name="subloop" title="drag onto a loop below">+ subloop</span>
    </div>
</div>
 
<div id="editor" class="ui-layout-center">
</div>

</body>
</html>
