<html>
<head>
    <!-- Reference the theme's stylesheet on the Google CDN -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/start/jquery-ui.css" />
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>

    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/jquery.jqplot.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.cursor.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.errorbarRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.InteractiveLegend.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.FixedAspect.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.GracefulAxisRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.touchEvents.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.heatmapRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.colorbarRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/plotting_api2.js"></script>
    
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors_plugin_base.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/rectangle_interactor_plugin.js"></script>
    
    <script src="icejs/Ice.js"></script>
    <script src="icejs/Glacier2.js"></script>
    <script src="icejs/IceStorm.js"></script>
    <script src="icejs/IceGrid.js"></script>

    <script src="nicejs/slice/data.js"></script>
    <script src="nicejs/slice/devices.js"></script>
    <script src="nicejs/slice/console.js"></script>
    <script src="nicejs/slice/system.js"></script>
    <script src="nicejs/slice/dryrun.js"></script>
    <script src="nicejs/slice/exceptions.js"></script>
    <script src="nicejs/slice/nice.js"></script>
    <script src="nicejs/slice/events.js"></script>
    <script src="nicejs/slice/experiment.js"></script>
    <script src="nicejs/slice/queue.js"></script>
    <script src="nicejs/slice/sampleAlignment.js"></script>
    <script src="nicejs/slice/clientapi.js"></script>
    <script src="JSON.parseMore.js"></script>
    <script src="testdata.js"></script>
    <script type="text/javascript">
        var Promise = Ice.Promise;
        var RouterPrx = Glacier2.RouterPrx;
        
        var router = "Glacier2/router:ws -p 4064 -h h123062.ncnr.nist.gov";
        
        var State = {
            Disconnected: 0,
            Connecting: 1,
            Connected:2
        };

var state = State.Disconnected;
var hasError = false;
active = false;

var signin = function()
{
    var communicator;
    var router;
    Promise.try (
        function()
        {
            //
            // Start animating the loading progress bar.
            //
            //startProgress();

            var hostname = document.location.hostname || "127.0.0.1";
            //
            // If the demo is accessed vi https, use a secure (WSS) endpoint, otherwise
            // use a non-secure (WS) endpoint.
            //
            // The web server will act as a reverse proxy for WebSocket connections. This
            // facilitates the setup of WSS with self-signed certificates because Firefox
            // and Internet Explorer certificate exceptions are only valid for the same
            // port and host.
            //
            var secure = document.location.protocol.indexOf("https") != -1;
            var router = secure ? "Glacier2/router:wss -p 4065 -h " + hostname :
                                  "Glacier2/router:ws -p 4064 -h " + hostname ;

            //
            // Initialize the communicator with the Ice.Default.Router property
            // set to the chat demo Glacier2 router.
            //
            var id = new Ice.InitializationData();
            id.properties = Ice.createProperties();
            id.properties.setProperty("Ice.Default.Router", router);
            id.properties.setProperty("Ice.Default.EncodingVersion", "1.0");
            id.properties.setProperty("Ice.ACM.Client", "0");
            id.properties.setProperty("Ice.MessageSizeMax", "100000");

            communicator = Ice.initialize(id);
            
            cm = communicator;
            //
            // Get a proxy to the Glacier2 router using checkedCast to ensure
            // the Glacier2 server is available.
            //
            rt_prx = RouterPrx.checkedCast(communicator.getDefaultRouter());
            //console.log(rt_prx);
            return rt_prx;
        }
    ).then(
        function(r, s)
        {
            myrouter = r;
            
            //console.log(r, s);
            //
            // Create a session with the Glacier2 router.
            //
            var s = myrouter.createSession("", "");
            //console.log(s);
            return s
        }
    ).then(
        function(session)
        {   
            //console.log(session)
            mysession = session;
            mgr = nice.api.Glacier2ClientApiSessionPrx.uncheckedCast(session);
            //mgr = Glacier2ClientManagerApiPrx.uncheckedCast(session);
            return mgr;
            //run(communicator, router, ChatSessionPrx.uncheckedCast(session));
        }
    ).then(
        function(mgr){
            ca = mgr.getAPI('client');
            return ca;
        }
    ).then(
        function(ca) {
            cam = nice.api.ClientApiPrx.checkedCast(ca);
            return cam;
        }
    ).then(
        function(api) {
            my_api = api;
            var adapter = communicator.createObjectAdapterWithRouter("", myrouter);
            return adapter
        }
    ).then(
        function(adapter) {
            myadapter = adapter;
            active = true;
            setupDevicesMonitor(my_api, myrouter, myadapter);
            //setupConsoleMonitor(myrouter, communicator,  mysession);
            //run(communicator, myrouter, mysession);
        }
    ).exception(
        function(ex)
        {
            //
            // Handle any exceptions that occurred during session creation.
            //
            alert(ex.toString());
            
            if(communicator)
            {
                communicator.destroy();
            }
        });
};

var DevicesMonitorI = Ice.Class(nice.api.devices.DevicesMonitor, {
    onSubscribe: function(devices, nodes, groups, __current) {
        this.devices = this.HashMapToObject(devices);
        this.nodes = this.HashMapToObject(nodes);
        this.groups = this.HashMapToObject(groups);
        this.postChangedHooks = (this.postChangedHooks == null) ? [] : this.postChangedHooks;
    },
    changed: function(nodes, __current) {
        var changed = this.HashMapToObject(nodes);
        jQuery.extend(this.nodes, changed);
        this._lastChanged = changed;
        this.postChangedHooks.forEach( function(callback) { callback(changed); });
    },
    removed: function(devices, nodes, __current) {
        this._lastDevicesRemoved = this.HashMapToObject(devices);
        this._lastNodesRemoved = this.HashMapToObject(nodes);
    },
    added: function(devices, nodes, __current) {
        this._lastDevicesAdded = this.HashMapToObject(devices);
        this._lastNodesAdded = this.HashMapToObject(nodes);
    },
    getAllDeviceNames: function() {
        var devices = [];
        this.devices.forEach(function(d) { devices.push(d); });
        return devices;
    },
    HashMapToObject: function(m) {
        var obj={}; 
        m.forEach( function(dn) { 
            obj[dn]=m.get(dn);
        }); 
        return obj
    } 
});


var setupDevicesMonitor = function(api, router, adapter) {
    var setup = new Promise();

    //
    // Get the session timeout and the router client category, and
    // create the client object adapter.
    //
    // Use Ice.Promise.all to wait for the completion of all the
    // calls.
    //
    Promise.all(
        router.getSessionTimeout(),
        router.getCategoryForClient()
    ).then(
        function(timeoutArgs, categoryArgs, adapterArgs)
        {
            var timeout = timeoutArgs[0];
            var category = categoryArgs[0];
            //var adapter = adapterArgs[0];

            //
            // Create the ChatCallback servant and add it to the
            // ObjectAdapter.
            //
            var dvmI = new DevicesMonitorI();
            dvmI.postChangedHooks = [
                function(nodes) { 
                    if ('areaDetector.counts' in nodes) {
                        show2dData(plotAreaDetector('areaDetector'), 'plotwrap');
                    }
                }
            ];
            var dvmPrx = nice.api.devices.DevicesMonitorPrx.uncheckedCast(adapter.add(dvmI, new Ice.Identity("devicesMonitor", category)));
            api.subscribeToDevices(dvmPrx);
            devicesMonitor = dvmI;
            
            return dvmI;
        }
    );
}

var plottable2d = {
    "dims": {
        "xdim": 128, 
        "xmax": 128, 
        "xmin": 0.0, 
        "ydim": 128, 
        "ymax": 128, 
        "ymin": 0.0, 
        "zmax": 899.0, 
        "zmin": 1.0
    },
    "options": {
        "fixedAspect": {
            "aspectRatio": 1.0, 
            "fixAspect": true
        },
        "axes": {
	       xaxis: {renderer: $.jqplot.GracefulAxisRenderer, tickOptions: {fontSize: 18}, labelOptions: {fontSize: 18}},
	       yaxis: {renderer: $.jqplot.GracefulAxisRenderer, tickOptions: {fontSize: 18}, labelOptions: {fontSize: 18}}
	    }
    }, 
    "title": "live 2d data", 
    "type": "2d", 
    "xlabel": "X", 
    "ylabel": "Y", 
    "z": [],
    "zlabel": "Intensity (I)"
}

    var plotAreaDetector = function(deviceName) {
        var target = 'plotwrap';
        var countsNodeName = deviceName + '.' + 'counts';
        if (!(countsNodeName in devicesMonitor.nodes)) {
            console.log('no counter node named ' + countsNodeName);
            return
        }
        var zdata = devicesMonitor.nodes[countsNodeName].currentValue.userVal.val;
        var dimNodeName = deviceName + '.' + 'dimension';
        if (!(dimNodeName in devicesMonitor.nodes)) {
            console.log('no counter node named ' + dimNodeName);
            return
        }
        var dims = devicesMonitor.nodes[dimNodeName].currentValue.userVal.val;
        var z = []
        var rowlength = dims[0];
        var zmax = -Infinity;
        var zmin = Infinity;
        var row, zmaxtemp, zmintemp;
        for (var i=0; i<rowlength; i++) {
            row = zdata.slice(i*rowlength, (i+1) * rowlength);
            zmaxtemp = Math.max.apply(Math, row);
            zmintemp = Math.min.apply(Math, row);
            zmax = Math.max(zmax, zmaxtemp);
            zmin = Math.min(zmin, zmintemp);
            z.push(row);
        }
        var plottable = {};
        jQuery.extend(true, plottable, plottable2d);
        plottable.z = [z];
        plottable.dims.xdim = plottable.dims.xmax = dims[0];
        plottable.dims.ydim = plottable.dims.ymax = dims[1];
        plottable.dims.zmin = zmin;
        plottable.dims.zmax = zmax;
        return plottable;
    }

    var show2dData = function(data, next_target) {
        if (!(plots[next_target])) {
            // if there is no plot, then create one:
            $('#' + next_target).empty();
            //if (!(counterNodeName in devicesMonitor.nodes)) {
            //    return
            //}
            
            var transform = 'lin';
            var plotbox = $('<div />', {class:'ui-widget-content', style:"display: block; width: 100%; height: 100%;", id:"plotbox"});
            $('#' + next_target).append(plotbox)
            plotbox.append($('<div />', {
                style:"display: inline-block; left: 0; top: 0; width:"+(plotbox.width()-150).toFixed()+"px; height: 100%;", 
                id:next_target + "_plot"}));
            plotbox.append($('<div />', {style:"display: inline-block; width: 100px; height: 100%;", id:next_target + "_colorbar"}));
            var plot = renderImageData2(data, transform, next_target + "_plot");
            var cbar_options = {
                axes: {y2axis: {renderer: $.jqplot.GracefulAxisRenderer, tickOptions: {fontSize: 18}, labelOptions: {fontSize: 18}}},
                interactors: [{"type": "master", "scrollZoom": true, "dragPan": true, "forceload": true}]
            }
            var colorbar = renderImageColorbar2(plot.series[0], next_target + '_colorbar');
            if (next_target in plots && plots[next_target].destroy) {
                plots[next_target].destroy();
            }
            plots[next_target] = null;
            plots[next_target] = plot;
            colorbars[next_target] = colorbar;
            plot.replot(); // for aspect ratio plugin!
            colorbar.plugins._interactor.zoomMax(); // for scale!
        } else {
            var plot = plots[next_target]
            plot.series[0].set_data(data.z[0], data.dims);
        }
        
    }

    window.onload = function() {
        plots = {};
        colorbars = {};
        signin();
    }
  </script>
  <style type="text/css">
    #command {
        width: 100%;
        height: 50px;
        background:#F0F0F0;
        position: fixed;
        top: 0;
        left: 0;
    }
    #command input {
        width: 1005;
        height: 30px;    
    }
    #plotwrap {
        width: 100%;
        height 100%;
    }
  </style>
</head>
<body>
<div id="plotwrap"></div>
</body>
</html>
