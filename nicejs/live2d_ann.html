<html>
<head>
    <!-- Reference the theme's stylesheet on the Google CDN -->
    
    <link rel="icon" type="image/png" href="css/appicon.png" />
    <link rel="stylesheet" type="text/css" href="../../niceclient/static/css/layout-default-latest.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Special+Elite" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Love+Ya+Like+A+Sister" />
    <link href="http://code.jquery.com/ui/1.10.4/themes/start/jquery-ui.css"
            type="text/css" rel="Stylesheet" />
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script> 
    <script type="text/javascript" src="//code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../../niceclient/static/jquery.layout-latest.js"></script>
<!--    Moved this to local host because it loads so slowly.-->
<!--    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>-->
    <script type="text/javascript" src="d3.v3.min.js"></script>
    <script type="text/javascript" src="plot_d3_rz.js"></script>

    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/jquery.jqplot.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot/plugins/jqplot.cursor.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.errorbarRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.InteractiveLegend.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.FixedAspect.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.GracefulAxisRenderer.js"></script>
<!--    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.touchEvents.js"></script>-->
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.heatmapRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.colorbarRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/plotting_api2.js"></script>   
<!--    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/plugins/jqplot.set_transform.js"></script>-->
    
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/interactors_plugin_base.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/rectangle_interactor_plugin.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.science/interactors/circle_interactor_plugin.js"></script>
    
    <!-- dialog support -->
    <link rel="stylesheet" href="../static/dialog-polyfill.css" />
    <script type="text/javascript" src="../static/dialog-polyfill.js"></script>
    
    <script src="icejs/Ice.js"></script>
    <script src="icejs/Glacier2.js"></script>
    <script src="icejs/IceStorm.js"></script>
    <script src="icejs/IceGrid.js"></script>

    <script src="generated/data.js"></script>
    <script src="generated/devices.js"></script>
    <script src="generated/console.js"></script>
    <script src="generated/system.js"></script>
    <script src="generated/dryrun.js"></script>
    <script src="generated/exceptions.js"></script>
    <script src="generated/nice.js"></script>
    <script src="generated/events.js"></script>
    <script src="generated/experiment.js"></script>
    <script src="generated/queue.js"></script>
    <script src="generated/sampleAlignment.js"></script>
    <script src="generated/clientapi.js"></script>
    <script src="connect_zeroc.js"></script>
    <script src="JSON.parseMore.js"></script>
    <script src="testdata.js"></script>
    <script type="text/javascript">
        var Promise = Ice.Promise;
        var RouterPrx = Glacier2.RouterPrx;
        
        var router = "Glacier2/router:ws -p 4064 -h h123062.ncnr.nist.gov";
                
        var logging_in = false;
        var link = {};
        var hostname = "h123062.ncnr.nist.gov"; // default NICE host
        if (localStorage && localStorage.nice_hostname) {
            hostname = localStorage.nice_hostname
        }
        
        var detectors = {areaDetector: {dims: null, data: null, beamCenterX: null, beamCenterY: null}};
        currently_drawing = false;
        draw_again = false;
        var refreshRequested = false;
        var phisumRequested = false;
        var sl; // slice listener.
        var maskCanvas; // for integrations

        var hasError = false;
        active = false;

        function capitalize(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        var DevicesMonitorI = Ice.Class(nice.api.devices.DevicesMonitor, {
            onSubscribe: function(devices, nodes, groups, __current) {
                this.devices = this.HashMapToObject(devices);
                this.nodes = this.HashMapToObject(nodes);
                var changed = this.nodes;
                this.groups = this.HashMapToObject(groups);
                this.postChangedHooks = (this.postChangedHooks == null) ? [] : this.postChangedHooks;
                this.postChangedHooks.forEach( function(callback) { callback(changed); });
            },
            
            changed: function(nodes, __current) {
                var changed = this.HashMapToObject(nodes);
                jQuery.extend(this.nodes, changed);
                this._lastChanged = changed;
                this.postChangedHooks.forEach( function(callback) { callback(changed); });
            },
            dynamicDevicesAdded: function(addRemoveID, childDeviceIDs, __current) {
                alert('device added: ' + addRemoveID + '\n' + 'children: ' + childDeviceIDs);
            },
            dynamicDevicesRemoved: function(addRemoveID, __current) {
                alert('device removed: ' + addRemoveID);
            },
            removed: function(devices, nodes, __current) {
                this._lastDevicesRemoved = this.HashMapToObject(devices);
                this._lastNodesRemoved = this.HashMapToObject(nodes);
            },
            added: function(devices, nodes, __current) {
                this._lastDevicesAdded = this.HashMapToObject(devices);
                this._lastNodesAdded = this.HashMapToObject(nodes);
            },
            getAllDeviceNames: function() {
                var devices = [];
                for (var d in this.devices) {
                    devices.push(d); 
                }
                return devices;
            },
            HashMapToObject: function(m) {
                var obj={}; 
                m.forEach( function(dn) { 
                    obj[dn]=m.get(dn);
                }); 
                return obj
            } 
        });

        var plottableX = {
            "options": {
                "series": [{"label": "phi-slice"}]
            },
            "data": [[[1,2], [3,4], [5,6]]]
            
        }
        var plottableY = {
            "options": {
                "series": [{"label": "y-slice"}]
            },
            "data": [[[1,2], [3,4], [5,6]]] 
        }
        
        var plottable2d = {
            "dims": {
                "xdim": 128, 
                "xmax": 128, 
                "xmin": 0.0, 
                "ydim": 128, 
                "ymax": 128, 
                "ymin": 0.0, 
                "zmax": 899.0, 
                "zmin": 1.0
            },
            "options": {
                "interactors": [
                    { type:'master', 
                      scrollZoom: true, 
                      dragPan: true, 
                      rightZoom: false, 
                      alpha: 0.8 },                                      
                    { type: 'Annulus',
                      name: 'annulus',
                      center_x: 50,
                      center_y: 50,
                      filled: false,
                      show_pos: false,
                      r1_x: 100,
                      r1_y: 50,
                      r2_x: 110,
                      r2_y: 60}
                ],
                "sortData": false,
		        "renderer": $.jqplot.heatmapRender,
		        "series": [ {shadow: false, padding: 0, showMarker:false, showLine:false, breakOnNull:true} ],
		        "grid": {shadow: false},
                "fixedAspect": {
                    "aspectRatio": 1.0, 
                    "fixAspect": true
                },
                "transform": {"zaxis": "log"},
                "seriesDefaults": {
                    "shadow": false,
                    "rendererOptions": {"transform": "log"},
                    "renderer": $.jqplot.heatmapRenderer
                },
                "axesDefaults": {
                },
                "axes": {
                    xaxis: {renderer: $.jqplot.GracefulAxisRenderer, labelRenderer: $.jqplot.AxisLabelRenderer, tickRenderer: $.jqplot.AxisTickRenderer},
                    yaxis: {renderer: $.jqplot.GracefulAxisRenderer, labelRenderer: $.jqplot.AxisLabelRenderer, tickRenderer: $.jqplot.AxisTickRenderer}	               
	            },
	            "cursor": null
            }, 
            "title": "live 2d data", 
            "type": "2d", 
            "xlabel": "X", 
            "ylabel": "Y", 
            "z": [],
            "zlabel": "Intensity (I)",
        }
        
        var plotAreaDetector = function(detectorName) {
            var target = 'plotwrap';
            var detector = detectors[detectorName];
            var zdata = detector.data; //devicesMonitor.nodes[countsNodeName].currentValue.userVal.val;
            var dims = detector.dims;
            var roi = detector.roi;
            var z = []
            var rowlength = dims[0];
            var zmax = -Infinity;
            var zmin = Infinity;
            var row, zmaxtemp, zmintemp;
            for (var i=0; i<rowlength; i++) {
                row = zdata.slice(i*rowlength, (i+1) * rowlength);
                zmaxtemp = Math.max.apply(Math, row);
                zmintemp = Math.min.apply(Math, row);
                zmax = Math.max(zmax, zmaxtemp);
                zmin = Math.min(zmin, zmintemp);
                z.push(row);
            }
            var plottable = {};
            jQuery.extend(true, plottable, plottable2d);
            plottable.z = [z];
            plottable.dims.xdim = plottable.dims.xmax = dims[0];
            plottable.dims.ydim = plottable.dims.ymax = dims[1];
            plottable.dims.zmin = zmin;
            plottable.dims.zmax = zmax;
            
            return plottable;
        }
    
    var updateLoop = function() {
        if (refreshRequested) {
            refreshRequested = false;
            show2dData(plotAreaDetector('areaDetector'), 'plotwrap');
        }
        if (phisumRequested) {
            phisumRequested = false;
            if (sl && sl.update_actual) {
                sl.update_actual();
            }
        }
        requestAnimationFrame(updateLoop);
    }
    
    requestAnimationFrame(updateLoop); // start the drawing loop;
    
    var setMaskWindow = function(xmin, xmax, ymin, ymax) {
        // limits should be in pixels
        var set_string = "{name=rect, ";
        set_string += "x1=" + xmin.toFixed(0) + ", ";
        set_string += "x2=" + xmax.toFixed(0) + ", ";
        set_string += "y1=" + ymin.toFixed(0) + ", ";
        set_string += "y2=" + ymax.toFixed(0) + "}";
        return api.move(["areaDetector.roiShape", set_string], false)
    }
    
    var updateTransform = function(ev) {
        if (plots && plots.plotwrap && colorbars && colorbars.plotwrap) {
            var logselected = ev.target.checked; 
            var transform = logselected? 'log' : 'lin';
            plots.plotwrap.series[0].set_transform(transform);
            colorbars.plotwrap.plugins._interactor.zoomMax();
            sl.update();
        }
    }
    
    var show2dData = function(data, next_target) {
        if (!(plots[next_target])) {
            // if there is no plot, then create one:
            $('#' + next_target).empty();
            
            var transform = 'log';
            var plotbox = $('<div />', {class:'ui-widget-content', style:"display: block; width: 100%; height: 100%;", id:"plotbox"});
            $('#' + next_target).append(plotbox)
            plotbox.append($('<div />', {
                style:"display: inline-block; left: 0; top: 0; width:"+(plotbox.width()-150).toFixed()+"px; height: 100%;", 
                id:next_target + "_plot"}));
            plotbox.append($('<div />', {style:"display: inline-block; width: 100px; height: 100%;", id:next_target + "_colorbar"}));
            var ztransform = $('<label />', {'class': 'transform', 'axis': 'zaxis'})
                .text('logZ')
                .append($('<input />', {'type': 'checkbox', 'id': 'ztransform', 'checked': true}));
            plotbox.append(ztransform);
            ztransform.prop('checked', true).change(updateTransform);
            var plot = renderImageData2(data, transform, next_target + "_plot");
            
            var cbar_options = {
                //axes: {y2axis: {renderer: $.jqplot.GracefulAxisRenderer, tickOptions: {fontSize: 18}, labelOptions: {fontSize: 18}}},
                axes: {y2axis: {renderer: $.jqplot.GracefulAxisRenderer, labelRenderer: $.jqplot.AxisLabelRenderer, tickRenderer: $.jqplot.AxisTickRenderer}},
                interactors: [{"type": "master", "scrollZoom": true, "dragPan": true, "forceload": true}]
            }
            var colorbar = renderImageColorbar2(plot.series[0], next_target + '_colorbar', cbar_options);
            if (next_target in plots && plots[next_target].destroy) {
                plots[next_target].destroy();
            }
            plots[next_target] = null;
            plots[next_target] = plot;
            colorbars[next_target] = colorbar;
            plot.series[0].generate_cumsums();
            plot.replot(); // for aspect ratio plugin!
            colorbar.plugins._interactor.zoomMax(); // for scale!
            
            var slice_annulus = plot.plugins.interactors.annulus;
            var r1ctl = new radiusTextControl(slice_annulus.c, slice_annulus.p1, 'r', 'r<sub>1</sub>', 5);
            r1ctl.div.setAttribute('style', 'display: inline; text-align: center; width: 100%; padding: 5px 10px;');
            document.getElementById('slicecontrols').appendChild(r1ctl.div);
            var r2ctl = new radiusTextControl(slice_annulus.c, slice_annulus.p2, 'r', 'r<sub>2</sub>', 5);
            r2ctl.div.setAttribute('style', 'display: inline; text-align: center; width: 100%; padding: 5px 10px;');
            document.getElementById('slicecontrols').appendChild(r2ctl.div);
            document.getElementById('slicecontrols').appendChild(document.createElement('br'));
            var centerxctl = new pointTextControl(slice_annulus.c, 'x', 'center<sub>x</sub>', 5);
            centerxctl.div.setAttribute('style', 'display: inline; text-align: center; width: 100%; padding: 5px 10px;');
            document.getElementById('slicecontrols').appendChild(centerxctl.div);
            var centeryctl = new pointTextControl(slice_annulus.c, 'y', 'center<sub>y</sub>', 5);
            centeryctl.div.setAttribute('style', 'display: inline; text-align: center; width: 100%; padding: 5px 10px;');
            document.getElementById('slicecontrols').appendChild(centeryctl.div);

            var hr = document.createElement('div'); hr.innerHTML = "<hr>";
            document.getElementById('slicecontrols').appendChild(hr);
            

            document.getElementById('slicecontrols').appendChild(document.createElement('hr'));
            var moveToButton = document.createElement('input');
            moveToButton.setAttribute('type', 'button');
            moveToButton.setAttribute('class', 'move-to-beam-center');
            moveToButton.setAttribute('value', 'Move to beam center');
            var moveToBeamCenter = function() {
                var x = null, y = null;
                if ('beamStop.beamCenterX' in devicesMonitor.nodes) {
                    x = devicesMonitor.nodes['beamStop.beamCenterX'].currentValue.userVal.val; 
                }
                if ('beamStop.beamCenterY' in devicesMonitor.nodes) {
                    y = devicesMonitor.nodes['beamStop.beamCenterY'].currentValue.userVal.val;
                }
                if (x != null && y != null) {
                    centerxctl.update({x: x});
                    centerxctl.update_external();
                    centeryctl.update({y: y});
                    centeryctl.update_external();
                    
                    //slice_annulus.c.coords.x = x;
                    //slice_annulus.c.coords.y = y;
                    //plot.redraw();
                    //if (sl.update) sl.update();
                } else {
                    alert('beam center is not defined');
                }
            };
            moveToButton.onclick = moveToBeamCenter;
            document.getElementById('slicecontrols').appendChild(moveToButton);
            //var roiDisplay = document.createElement('div');
            //roiDisplay.setAttribute('class', 'roi-display');
            //roiDisplay.setAttribute('id', 'roi_display');
            //roiDisplay.innerHTML = JSON.stringify(shape);
            //document.getElementById('slicecontrols').appendChild(roiDisplay);
            
            slice_listener = function(series) {
                slice_annulus.p1.listeners.push(this);
                slice_annulus.p2.listeners.push(this);
                slice_annulus.c.listeners.push(this);
                var p0 = series;
                this.update = function(pos) {
                    phisumRequested = true;
                    //this.update_actual();
                }
                this.update_actual = function() {
                    var zislog = document.getElementById('ztransform').checked;
                    var intensity_label = (zislog) ? "Log counts" : "counts";
                    
                    var xdata = [], ydata = [];
                    
                    /*
                    var xi=0, yi=0;
                    for (var c=i_min; c <=i_max-1; c++) {
                        xdata[xi++] = ([p0.dims.xmin + c*p0.dims.dx, p0.cumsum_x[c][j_max] - p0.cumsum_x[c][j_min]]);
                    }
                    */
                    var r1 = dist(slice_annulus.p1.coords, slice_annulus.c.coords);
                    var r2 = dist(slice_annulus.p2.coords, slice_annulus.c.coords);
                    var phisum = multiplySumArc(p0.source_data, p0.dims, slice_annulus.c.coords.x, slice_annulus.c.coords.y, r1, r2);
                    plottableX.data = [phisum.xy];
                    $("#xplot_plot").empty();
                    xplot = plotD3("xplot_plot", plottableX, {log_y: zislog, showline: true, show_points: false, vcursor: true, ylabel: intensity_label, xlabel: 'Phi (deg)'});
                    
                    /*
                    for (var r=j_min; r<=j_max-1; r++) {
                        ydata[yi++] = ([p0.cumsum_y[i_max][r] - p0.cumsum_y[i_min][r], p0.dims.ymin + r*p0.dims.dy]);
                    }
                    plottableY.data = [ydata];
                    $("#yplot_plot").empty();
                    yplot = plotD3("yplot_plot", plottableY,  {log_x: zislog, showline: true, show_points: false, hcursor: true, xlabel: intensity_label});
                    */
                }
                return this;  
            };
            sl = slice_listener(plot.series[0]);
            maskCanvas.width = data.dims.xdim;
            maskCanvas.height = data.dims.ydim;
            sl.update();
            
        } else {
            var plot = plots[next_target];
            var colorbar = colorbars[next_target];
            plot.series[0].set_data(data.z[0], data.dims, true); // defer update: colorbar will trigger it later
            colorbar.series[0].set_dims(data.dims);
            //document.getElementById('roi_display').innerHTML = JSON.stringify(shape);
            //plot.replot();
            colorbar.plugins._interactor.zoomMax(); // for scale!
            colorbar.replot();
            maskCanvas.width = data.dims.xdim;
            maskCanvas.height = data.dims.ydim;
            sl.update();
        }
        
    }
    
    function radians(deg) {
        return Math.PI * deg/180.0;
    }
    function degrees(rad) {
        return 180.0 * rad/Math.PI;
    }
    
    function multiplySumArc(data, dims, center_x_coord, center_y_coord, r1_coord, r2_coord) {
         //var maskCanvas = document.getElementById('mask');
         var dxpos = (dims.xmax - dims.xmin) / (dims.xdim);
         var dypos = (dims.ymax - dims.ymin) / (dims.ydim);
         var center_x = (center_x_coord - dims.xmin) / dxpos;
         var center_y = (center_y_coord - dims.ymin) / dypos;
         var r1 = r1_coord / dxpos; // square pixels only!
         var r2 = r2_coord / dxpos; // square pixels only!
         //console.log(center_x, center_y, r1, r2);
         
         var ch = maskCanvas.height;
         var cw = maskCanvas.width;
         var maskCtx = maskCanvas.getContext('2d');
         var angle_start = radians(-10.5);
         var steps = 360;
         var stepsize = radians(1.0);
         var width = Math.abs(r2 - r1);
         var r = (r1 + r2) / 2.0;
         var angle=angle_start, maskData, sum, normalize, data;
         maskCtx.fillStyle='#000000'; // for erasing
         maskCtx.strokeStyle = '#ffffff'; // for drawing
         maskCtx.lineWidth = width;
         var angle_list=[], sum_list=[], normalize_list=[], xy_list=[];
         var max_x, max_y, min_x, min_y, x1, x2, y1, y2, dx, dy;
         var buffer_pixels = 3; // border around selection rectangle
         maskCtx.fillRect(0,0,cw,ch);
         for (var s=0; s<steps; s++) {            
            maskCtx.beginPath();
            maskCtx.arc(center_x, center_y, r, -angle, -(angle + stepsize), true);
            maskCtx.stroke();
            // assuming small steps: linear!
            x1 = center_x + (Math.cos(angle) * r1); 
            y1 = center_y - (Math.sin(angle) * r1); // plus is down
            x2 = center_x + (Math.cos(angle + stepsize) * r1);
            y2 = center_y - (Math.sin(angle + stepsize) * r1);
            x3 = center_x + (Math.cos(angle) * r2); 
            y3 = center_y - (Math.sin(angle) * r2); // plus is down
            x4 = center_x + (Math.cos(angle + stepsize) * r2);
            y4 = center_y - (Math.sin(angle + stepsize) * r2);
            x1 = Math.round(x1);
            x2 = Math.round(x2);
            y1 = Math.round(y1);
            y2 = Math.round(y2);
            x3 = Math.round(x3);
            x4 = Math.round(x4);
            y3 = Math.round(y3);
            y4 = Math.round(y4);
            max_x = Math.min(cw, Math.max(x1, x2, x3, x4) + buffer_pixels);
            min_x = Math.max(0, Math.min(x1, x2, x3, x4) - buffer_pixels);
            max_y = Math.min(ch, Math.max(y1, y2, y3, y4) + buffer_pixels);
            min_y = Math.max(0, Math.min(y1, y2, y3, y4) - buffer_pixels);
            dx = max_x - min_x;
            dy = max_y - min_y;
            //console.log(min_x, max_x, min_y, max_y, dx, dy);
            
            sum = 0;
            normalize = 0;
            
            if (dx > 0 && dy > 0) {                
                maskData = maskCtx.getImageData(min_x,min_y,dx,dy).data;
                //data = imgCtx.getImageData(min_x,min_y,dx,dy).data;
                
                for (var i=0; i<dx; i++) {
                    for (var j=0; j<dy; j++) {
                        var mi = (i*dy + j) * 4;
                        normalize += maskData[mi];
                        sum += maskData[mi] * data[min_x + i][min_y + j];
                    }
                }
            }
            angle_list[s] = angle;
            sum_list[s] = sum;
            normalize_list[s] = normalize;
            xy_list[s] = [degrees(angle), (normalize == 0)? 0 : sum/normalize];
            angle += stepsize;
            maskCtx.fillRect(min_x,min_y,dx,dy);
         }
         return {xy: xy_list, angle: angle_list, sum: sum_list, normalize: normalize_list}
    }
    
    pointTextControl = function(p, coord, label, precision) {
        // coord should be 'x' or 'y'
        var precision = precision || 3;
        this.precision = precision;
        this.coord = coord;
        this.p = p;
        var textbox = document.createElement('input');
        textbox.setAttribute('type', 'text');
        textbox.setAttribute('style', 'width:90px');
        var input_label = document.createElement('label');
        var div = document.createElement('div');
        div.innerHTML = label;
        // div.appendChild(document.createTextNode(label))
        div.appendChild(textbox);
        this.div = div;
        this.div.setAttribute('id', 'ptTextControl_' + label);
        this.div.setAttribute('style', 'display: inline; padding: 5px 10px;');
        //this.div.setAttribute('style', 'position: relative; float: left; padding: 5px; text-align: top;');
        this.textbox = textbox;
        this.update = function(pos) {
            textbox.value = pos[coord].toPrecision(precision);
        }
        var me = this;
        this.update_external = function() {
            var mypos = {}; mypos[coord] = textbox.value;
            
            var newpos = p.putCoords ? p.putCoords(mypos) : mypos;
            var dpos = {}; dpos[coord] = newpos[coord] - p.pos[coord];
            p.move(dpos);
            p.parent.onDrag();  // centers
            p.parent.redraw();
        }
        
        textbox.onchange = this.update_external;
        p.listeners.push(this);
        this.update(p.getCoords());
        return this;
    }
    
    dist = function(a, b) {
        return Math.sqrt(Math.pow(a.x - b.x, 2) + Math.pow(a.y - b.y, 2));
    };
    
    radiusTextControl = function(c, p, coord, label, precision) {
        // coord should be 'r' or 't' for r or theta
        var precision = precision || 3;
        this.precision = precision;
        this.coord = coord;
        this.p = p;
        this.c = c; // center
        var textbox = document.createElement('input');
        textbox.setAttribute('type', 'text');
        textbox.setAttribute('style', 'width:90px');
        var input_label = document.createElement('label');
        var div = document.createElement('div');
        div.innerHTML = label;
        // div.appendChild(document.createTextNode(label))
        div.appendChild(textbox);
        this.div = div;
        this.div.setAttribute('id', 'rTextControl_' + label);
        this.div.setAttribute('style', 'display: inline; padding: 5px 10px;');
        //this.div.setAttribute('style', 'position: relative; float: left; padding: 5px; text-align: top;');
        this.textbox = textbox;
        this.update = function(pos) {
            var r = dist(pos, c.coords);
            var t = Math.atan2(pos.y - c.coords.y, pos.x - c.coords.x);
            var rtpos = {'r': r, 't': t};
            textbox.value = rtpos[coord].toPrecision(precision);
        }
        var me = this;
        this.update_external = function() {
            var rtpos = {
                r: dist(p.coords, c.coords),
                t: Math.atan2(p.coords.y - c.coords.y, p.coords.x - c.coords.x)
            }
            rtpos[coord] = textbox.value;
            
            var mypos = {
                x: c.coords.x + Math.cos(rtpos.t) * rtpos.r,
                y: c.coords.y + Math.sin(rtpos.t) * rtpos.r
            }
                       
            var newpos = p.putCoords ? p.putCoords(mypos) : mypos;
            var dpos = {
                x: newpos.x - p.pos.x,
                y: newpos.y - p.pos.y
            }
            p.move(dpos);
            p.parent.onDrag();  // centers
            p.parent.redraw();
        }
        
        textbox.onchange = this.update_external;
        p.listeners.push(this);
        this.update(p.getCoords());
        return this;
    }
    
    
    dialog_login = function() {
        var hostname = document.getElementById("instrument_ip").value;
        var username = document.getElementById("username").value;
        var password = document.getElementById("password").value;
        
        signin_result = signin("NiceGlacier2/router:ws -p 9999 -h " + hostname, "1.0", true, username, password).then(
            function(communicator, router, session, adapter) {
                // globals:
                link.communicator = communicator
                link.router = router
                link.session = session
                link.monitor_adapter = adapter
                var mgr = nice.api.Glacier2ClientApiSessionPrx.uncheckedCast(session);
                return mgr.getAPI('client').then(
                    function(ca) {
                        return nice.api.ClientApiPrx.checkedCast(ca).then(
                            function(cam) {
                                api = cam;
                                devicesMonitor = new DevicesMonitorI();
                                devicesMonitor.postChangedHooks = [
                                    function(nodes) {
                                        if ('areaDetector.dimension' in nodes) {
                                            detectors.areaDetector.dims = nodes['areaDetector.dimension'].currentValue.userVal.val;
                                        }
                                        if ('areaDetector.counts' in nodes) {
                                            detectors.areaDetector.data = nodes['areaDetector.counts'].currentValue.userVal.val;
                                           
                                            window.refreshRequested = true;
                                        }
                                        if ('beamStop.beamCenterX' in nodes) {
                                            detectors.areaDetector.beamCenterX = nodes['beamStop.beamCenterX'].currentValue.userVal.val;
                                        }
                                        if ('beamStop.beamCenterY' in nodes) {
                                            detectors.areaDetector.beamCenterY = nodes['beamStop.beamCenterY'].currentValue.userVal.val;
                                        }
                                        
                                    }
                                ];
                                return subscribe(api, router, adapter, devicesMonitor, 'devices');
                        });
                });
        }).exception(
            function(ex) {console.log(ex)}
        );
        if (localStorage) {
            localStorage.nice_hostname = hostname;
        }
        document.getElementById("login").close();
        document.getElementById("top_panel").getElementsByClassName("instrument-name")[0].innerHTML="Instrument connected: " + hostname;
        document.getElementById("top_panel").classList.add("connected");
        logging_in = false;

    }
    
    var fitPlots = function() {
        if (plots && plots.plotwrap) {
            $('#plotwrap_plot').width($('#plotwrap').width() - 150);
            if (plots.plotwrap.replot) plots.plotwrap.replot();
            if (plots.plotwrap.plugins && plots.plotwrap.plugins.cursor.resetZoom) plots.plotwrap.plugins.cursor.resetZoom();
        }
        if (colorbars && colorbars.plotwrap && colorbars.plotwrap.replot) colorbars.plotwrap.replot();
        
        var xplot_width = $('#plotwrap').width() || 100;
        $('#xplot_plot').width(xplot_width);
        $('#slicecontrols').width($('.ui-layout-south').width() - xplot_width - 25); 
        if (sl && sl.update) sl.update();
    }
    
    window.onload = function() {
        plots = {};
        colorbars = {};
        maskCanvas = document.createElement('canvas');
        var dialog = document.getElementById("login");
        if (!dialog.show) {
            dialogPolyfill.registerDialog(dialog);
        }
        document.getElementById("instrument_ip").value = hostname;
        dialog.show();
        logging_in = true;
    
        var layout = $('body').layout({
		    east__size:			500
	    ,	west__size:			0
	    ,   south__size:        300
	    ,   north_size:         "auto"
		    // RESIZE Accordion widget when panes resize
	    ,	west__onresize:		$.layout.callbacks.resizePaneAccordions
	    ,	east__onresize:		$.layout.callbacks.resizePaneAccordions
	    ,	south__onresize:    $.layout.callbacks.resizePaneAccordions
	    ,	north__onresize:    $.layout.callbacks.resizePaneAccordions
	    ,   center__onresize:   "fitPlots"
	    });
	    
	    fitPlots();
        //signin();
    }
  </script>
  <style type="text/css">
    @font-face {
        font-family: xkcd;
        src: url("xkcd.otf");
    }

    body {
        font-family: 'Love Ya Like A Sister' !important;
    }
    #login {
        top: 28%;
        position: absolute;
        z-index: 10;
    }
    #plotwrap {
        width: 100%;
        height: 100%;
    }
    #top_panel {
        background-color: LightYellow;
        height: 30px;
        padding-top: 0px;
        padding-bottom: 0px;
        font-weight: normal;
        /* font-family: 'Open Sans' !important; */
        /* font-family: 'Special Elite' !important; */
        /* font-family: 'xkcd' !important; */
        /* font-variant: small-caps; */
    }
    #top_panel.connected {
        background-color: LightGreen;
    }
    #top_panel h3 {
        font-size: 16pt;
        margin-top: 6pt;
        margin-bottom: 6pt;
        font-weight: normal;
    }
    #xplot_plot {
        width: 50%;
        height: 100%;
        display: inline-block;
    }
    #yplot_plot {
        width: 100%;
        height: 100%;
    }
    #slicecontrols {
        width: 100%;
        height: 100%;
        display: inline-block;
        text-align: center;
    }
    .set-new-roi {
        background-color: #dd0000;
        color: white;
        margin-left: 30px;
        font-weight: bold;
    }
    label.transform {
        position: absolute;
        bottom: 10;
        left: 10;
    }
  </style>
  <style type="text/css">                    
    .grid .tick {
        stroke: lightgrey;
        opacity: 0.7;
        shape-rendering: crispEdges;
        user-select: none; 
        -webkit-user-select: none; 
        -moz-user-select: none;
    }
     
    .grid path {
        stroke-width: 0;
    }
     
    .axis path {
        fill: none;
        stroke: #bbb;
        shape-rendering: crispEdges;
    }
     
    .axis text {
        fill: #555;
    }
     
    .axis line {	
        stroke: #e7e7e7;
        shape-rendering: crispEdges;
    }
     
    .axis .axis-label {
        font-size: 14px;
        user-select: none; 
        -webkit-user-select: none; 
        -moz-user-select: none;
    }
    
    .legend, .tick {
        user-select: none; 
        -webkit-user-select: none; 
        -moz-user-select: none;
    }
     
    .line {
        fill: none;
        stroke-width: 1.5px;
    }
    
    .highlight {
        stroke-width: 4.5px;
    }
     
    .dot {
        /* consider the stroke-with the mouse detect radius? */
        stroke: transparent;
        stroke-width: 10px;  
        cursor: pointer;
    }
     
    .dot:hover {
        stroke: rgba(68, 127, 255, 0.3);
    }
    
    rect {
      fill: #fff;
      user-select: none; 
      -webkit-user-select: none; 
      -moz-user-select: none;
    }

    rect.zoom {
      stroke: steelblue;
      fill-opacity: 0.5;
    }
  </style>
  <title>Live 2d data</title>
</head>
<body>
<dialog id="login">
  <h2>Login</h2>
  <label for="instrument_ip">Instrument address</label>
  <input type="text" id="instrument_ip" value="happy.home">
  <br>
  <label for="username">Username:</label>
  <input type="text" id="username" value="" placeholder="username">
  <br>
  <label for="password">Password:</label>
  <input type="password" id="password" placeholder="password">
  <br>
  <input type="button" onclick="dialog_login()" value="Go">
</dialog>
<div id="top_panel" class="ui-layout-north">
    <h3 class="instrument-name">Instrument: </h3>
</div>
<div id="xplot" class="ui-layout-south">
    <div id="xplot_plot"></div>
    <div id="slicecontrols" class="controls"></div>
</div>
<div id="yplot" class="ui-layout-east">
    <div id="yplot_plot"></div>
</div>
<div id="plotwrap" class="ui-layout-wrapper ui-layout-center"></div>
</body>
</html>
