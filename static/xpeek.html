<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>XPeekWeb</title>
    
<!--    <link rel="stylesheet" type="text/css" href="/static/site.css" /> -->
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/themes/start/jquery-ui.css"
    type="text/css" rel="Stylesheet" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/jquery-ui.min.js" type="text/javascript"></script>
<!--    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.js"></script>-->
    <!--<script type="text/javascript" src="/static/socket.io-client/dist/socket.io.min.js"></script> -->
    <script type="text/javascript" src="/static/socket.io-0.9.6/socket.io.min.js"></script>
    <!-- <script type="text/javascript" src="/static/socket.io-0.9.6/socket.io.js"></script> -->
    <!-- <script type="text/javascript" src="/static/socket.io/socket.io.js"></script> -->
<!--    <script type="text/javascript" charset="utf-8" src="http://cdn.sencha.io/ext-4.1.1-gpl/ext-all.js"></script>-->
    <!-- <script type="text/javascript" src="/static/ext-4.1.1/bootstrap.js"></script> -->
    <!-- <script type="text/javascript" src="/static/ext-4.1.1/builds/ext-core-debug.js"></script> -->
    <!-- <script type="text/javascript" src="/static/ext-4.1.1/builds/ext-core.js"></script> -->
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jquery.jqplot.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.canvasTextRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.canvasAxisTickRenderer.min.js"></script>
	<script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jquery.jqplot.InteractiveLegend.js"></script>
	<script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.mobile.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/jqplot.cursor.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/heatmapRenderer.js"></script>
    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/colorbarRenderer.js"></script>

    <script type="text/javascript" src="http://ncnr.nist.gov/instruments/magik/plotting_api.js"></script>
    <script type="text/javascript" src="http://drneutron.org/static/lib/plotting/jqplot/jqplot.FixedAspect.js"></script>
    <script type="text/javascript" src="http://drneutron.org/static/lib/interactors/interactors_nonprototype.js"></script>
    <script type="text/javascript" src="http://drneutron.org/static/lib/interactors/interactor_plugin_base.js"></script>
    <script type="text/javascript" src="http://drneutron.org/static/lib/interactors/rectangle_interactor_plugin.js"></script>
    <script type="text/javascript">
        window.onload = function() {
            series = new Object();
            seriesdata = new Array();
            //data_ended = false; // trigger at the end of a data set.
            plot = null;
            preferred_xaxis = ['A04', 'A03']; // make these the x-axis, if they are available
            in_datastream = false;
            remake_plot = false;
            xaxis = null;
            
            var newPlottable = function(name, xlabel, ylabel) {
                plottable_data = {
                    'type': '1d',
                    'title': name,
                    'options': {'axes': {'xaxis': {'label':'A4'}, 'yaxis': {'label':'Counts'}},'series': []},
                    'clear_existing': true,
                    'data': []
                }
                return plottable_data
            }
            
            var resetData = function(state) {     
                console.log("reset data",state, state.records.length);
                if (!('records' in state)) { 
                    //console.log('no records!'); return; 
                }
                xaxis = null;
                for (var i=0; i < state.records.length; i++) {
                    in_datastream = false; // don't turn this on until live.
                    //console.log('resetData: processing record:', state.records[i]);
                    processRecord(state.records[i]);
                }
                in_datastream = true;
                remake_plot = true;
                updatePlot(series, xaxis);
            }

            var makePlot = function(series) {
                plottable_data = {
                    'type': '1d',
                    'title': name,
                    'options': {'axes': {'xaxis': {'label':'A4'}, 'yaxis': {'label':'Counts'}},'series': []},
                    'clear_existing': true,
                    'data': []
                }
                for (sername in series) {
                    var ser = series[sername];
                    if (ser.PT && ser.PT.length > 0) {
                        plottable_data.options.series.push({'label': sername});
                        var data = []
                        for (var i=0; i<ser.PT.length; i++) {
                            data.push([ser.PT[i], ser.A04]);
                        }
                        plottable_data.data.push(data);
                    }
                }
                if (plottable_data.data.length > 0) {
                    plot = plottingAPI([plottable_data], 'plot');
                }
                
            }
            
                        
            var updatePlot = function(series, xaxis) {
                plottable_data = {
                    'type': '1d',
                    'title': "XPeek data",
                    'options': {'axes': {'xaxis': {'label': xaxis}, 'yaxis': {'label':'Counts'}},'series': []},
                    'clear_existing': false,
                    'data': []
                }
                var plotdata = [];
                var ser;
                for (sername in series) {
                    var serdata = [];
                    ser = series[sername];
                    for (var i=0; i<ser.PT.length; i++) {
                        serdata.push([ser[xaxis][i], ser['DATA'][i]]);
                    }
                    plottable_data.data.push(jQuery.extend(true, [], serdata));
                    plottable_data.options.series.push({'label': sername});
                    plottable_data.title = String(ser.runid) + ' :: ' + String(ser.comment);
                    plotdata.push(jQuery.extend(true, [], serdata));
                }
                if (remake_plot == true) {
                    plottingAPI([plottable_data], 'plot');
                    plot = plot1d;
                    //$('#plot')[0].innerHTML = "";
                    //plot = jQuery.jqplot('plot', plotdata, {cursor:{show: true, zoom:true}});
                    remake_plot = false;
                } else {
                    //console.log(plotdata.length, plot.series.length);
                    for (var j=0; j<plotdata.length; j++) {
                        plot.series[j].data = plotdata[j];
                        jQuery.extend(true, plot.data, plotdata);
                        //plot.drawSeries(j);
                        plot.replot();
                    }
                }
            }
            
            var getXAxis = function(state) {
                for (var i=0; i<preferred_xaxis.length; i++) {
                    var xaxis = preferred_xaxis[i];
                    if (xaxis in state) { return xaxis }
                }
                return Object.keys(state)[0]
            }
              
            var addPoint = function(series, lineid, state) {
                //var remake_plot = false; // flag to trigger calling jqplot() again.
                //console.log('adding point: ', state, (lineid in series));
                if (!(lineid in series)) { 
                    series[lineid] = {};
                    remake_plot = true; 
                }
                var ser = series[lineid];
                //console.log('ser: ', ser);
                for (item in state) {
                    if (!(item in ser)) { ser[item] = []; }
                    ser[item].push(state[item]);
                }
                if (xaxis == null) { xaxis = getXAxis(state); }
                
                if (in_datastream == true) { 
                    updatePlot(series, xaxis);
                }
            }    

            var processRecord = function(record) {
                var lineid = record.lineid;
                //console.log(record);
                if (record.command == 'newdata') {
                    if (in_datastream == true) {
                        series = new Object();
                        xaxis = null;
                        in_datastream = false;
                    }
                    remake_plot = true;
                    series[lineid] = new Object();
                    series[lineid]['comment'] = record.comment;
                    series[lineid]['runid'] = record.runid;
                    //console.log("runid:", record.runid, "comment:", record.comment);
                } else if (record.command == 'enddata') {
                    data_ended = true;
                } else if (record.command == 'newpoint') {
                    in_datastream = true;
                    addPoint(series, lineid, record.pointdata);
                    //$('#metadata').innerHTML = "<b>ETA: </b>" + String(record.eta);
                    //jQuery.extend(true, series, newpoint);
                } else { 
                    console.log("update data, unrecognized command: ",record); 
                }
            }

            var Instrument = jQuery.getUrlVar('instrument') ? jQuery.getUrlVar('instrument') : "BT4";
            $('#content').html('Loading...' + Instrument);
            var BaseURL = 'http://' + window.location.hostname + ':' + window.location.port;
            var Root = BaseURL + '/' +Instrument;
            document.title = Instrument + ' status';
            
            var dataChannel = new io.connect(Root + '/data');
            dataChannel.on('connect', function () {
                //console.log("data connect");
                dataChannel.emit('subscribe', resetData);
            });
            dataChannel.on('reset', resetData);
            dataChannel.on('record', processRecord);
        }
    </script>
    <script src="/static/geturlvars.js"></script>


</head>
<body>
<div id="plot" style="width:700px;height:350px;">I am a plot</div>
<div id="metadata" />
</body>
</html>
